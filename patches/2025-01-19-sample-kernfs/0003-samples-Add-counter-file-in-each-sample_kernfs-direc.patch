From 22df86252033fb1f4028138ae6dc23e032750d47 Mon Sep 17 00:00:00 2001
From: David Reaver <me@davidreaver.com>
Date: Sun, 19 Jan 2025 14:37:16 -0800
Subject: [PATCH 3/4] samples: Add counter file in each sample_kernfs directory

Signed-off-by: David Reaver <me@davidreaver.com>
---
 samples/kernfs/sample_kernfs.c | 60 ++++++++++++++++++++++++++++++++++
 1 file changed, 60 insertions(+)

diff --git a/samples/kernfs/sample_kernfs.c b/samples/kernfs/sample_kernfs.c
index 452a6f49ac06..edc569a043f0 100644
--- a/samples/kernfs/sample_kernfs.c
+++ b/samples/kernfs/sample_kernfs.c
@@ -14,6 +14,60 @@
 
 #define SAMPLE_KERNFS_MAGIC 0x8d000ff0
 
+struct sample_kernfs_directory {
+	atomic64_t count;
+};
+
+static int sample_kernfs_counter_seq_show(struct seq_file *sf, void *v)
+{
+	// Extract our counter file from the kernfs node's private data.
+	struct kernfs_open_file *of = sf->private;
+	struct kernfs_node *dir_kn = kernfs_get_parent(of->kn);
+	struct sample_kernfs_directory *counter_dir = dir_kn->priv;
+
+	u64 count = atomic64_inc_return(&counter_dir->count);
+	seq_printf(sf, "%llu\n", count);
+	return 0;
+}
+
+static struct kernfs_ops sample_kernfs_counter_kf_ops = {
+	.seq_show	= sample_kernfs_counter_seq_show,
+};
+
+static int sample_kernfs_add_counter_file(struct kernfs_node *dir_kn)
+{
+	struct kernfs_node *kn;
+	kn = __kernfs_create_file(dir_kn, "counter", 0666, current_fsuid(),
+				  current_fsgid(), 0,
+				  &sample_kernfs_counter_kf_ops, NULL,
+				  NULL, NULL);
+
+	if (IS_ERR(kn))
+		return PTR_ERR(kn);
+
+	return 0;
+}
+
+static int sample_kernfs_populate_dir(struct kernfs_node *dir_kn)
+{
+	// We allocate a struct to hold the counter, which gets stuffed into the
+	// private data of the kernfs_node for this directory.
+	//
+	// TODO: When we implement creating/removing directories, ensure we free
+	// this.
+	struct sample_kernfs_directory *dir;
+	dir = kzalloc(sizeof(struct sample_kernfs_directory), GFP_KERNEL);
+	if (!dir)
+		return -ENOMEM;
+	dir_kn->priv = dir;
+
+	int err = sample_kernfs_add_counter_file(dir_kn);
+	if (err)
+		return err;
+
+	return 0;
+}
+
 static int sample_kernfs_get_tree(struct fs_context *fc)
 {
 	return kernfs_get_tree(fc);
@@ -41,6 +95,12 @@ static int sample_kernfs_init_fs_context(struct fs_context *fc)
 	fc->ops = &sample_kernfs_fs_context_ops;
 	fc->global = true;
 
+	int err = sample_kernfs_populate_dir(kernfs_root_to_node(root));
+	if (err) {
+		kernfs_destroy_root(root);
+		return err;
+	}
+
 	return 0;
 }
 
