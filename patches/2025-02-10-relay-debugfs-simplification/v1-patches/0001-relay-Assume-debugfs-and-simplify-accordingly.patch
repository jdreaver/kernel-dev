From 7f3703be43daead8841623e4b9a1bbefc49942f6 Mon Sep 17 00:00:00 2001
From: David Reaver <me@davidreaver.com>
Date: Mon, 10 Feb 2025 16:30:48 -0800
Subject: [RFC PATCH] relay: Assume debugfs and simplify accordingly
To: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>,
    linux-fsdevel@vger.kernel.org,
    linux-kernel@vger.kernel.org,
    David Reaver <me@davidreaver.com>

While the relay documentation suggests support for non-debugfs users, in
practice all relay users rely on debugfs.

Signed-off-by: David Reaver <me@davidreaver.com>
---
 drivers/gpu/drm/i915/gt/uc/intel_guc_log.c         | 10 ----------
 drivers/net/wireless/ath/ath10k/spectral.c         |  8 --------
 drivers/net/wireless/ath/ath11k/spectral.c         |  8 --------
 drivers/net/wireless/ath/ath9k/common-spectral.c   |  8 --------
 .../net/wireless/mediatek/mt76/mt7915/debugfs.c    |  9 ---------
 .../net/wireless/mediatek/mt76/mt7996/debugfs.c    |  9 ---------
 drivers/net/wwan/iosm/iosm_ipc_trace.c             |  8 --------
 drivers/net/wwan/t7xx/t7xx_port_trace.c            |  7 -------
 include/linux/relay.h                              | 14 --------------
 kernel/relay.c                                     |  5 +++--
 kernel/trace/blktrace.c                            |  9 ---------
 11 files changed, 3 insertions(+), 92 deletions(-)

diff --git a/drivers/gpu/drm/i915/gt/uc/intel_guc_log.c b/drivers/gpu/drm/i915/gt/uc/intel_guc_log.c
index e8a04e476c57..afdbe66ee43c 100644
--- a/drivers/gpu/drm/i915/gt/uc/intel_guc_log.c
+++ b/drivers/gpu/drm/i915/gt/uc/intel_guc_log.c
@@ -269,20 +269,10 @@ static struct dentry *create_buf_file_callback(const char *filename,
 	return buf_file;
 }
 
-/*
- * file_remove() default callback. Removes relay file in debugfs.
- */
-static int remove_buf_file_callback(struct dentry *dentry)
-{
-	debugfs_remove(dentry);
-	return 0;
-}
-
 /* relay channel callbacks */
 static const struct rchan_callbacks relay_callbacks = {
 	.subbuf_start = subbuf_start_callback,
 	.create_buf_file = create_buf_file_callback,
-	.remove_buf_file = remove_buf_file_callback,
 };
 
 static void guc_move_to_next_buf(struct intel_guc_log *log)
diff --git a/drivers/net/wireless/ath/ath10k/spectral.c b/drivers/net/wireless/ath/ath10k/spectral.c
index 2240994390ed..4a97141d7c35 100644
--- a/drivers/net/wireless/ath/ath10k/spectral.c
+++ b/drivers/net/wireless/ath/ath10k/spectral.c
@@ -480,16 +480,8 @@ static struct dentry *create_buf_file_handler(const char *filename,
 	return buf_file;
 }
 
-static int remove_buf_file_handler(struct dentry *dentry)
-{
-	debugfs_remove(dentry);
-
-	return 0;
-}
-
 static const struct rchan_callbacks rfs_spec_scan_cb = {
 	.create_buf_file = create_buf_file_handler,
-	.remove_buf_file = remove_buf_file_handler,
 };
 
 int ath10k_spectral_start(struct ath10k *ar)
diff --git a/drivers/net/wireless/ath/ath11k/spectral.c b/drivers/net/wireless/ath/ath11k/spectral.c
index 79e091134515..0cf0a2de0fb9 100644
--- a/drivers/net/wireless/ath/ath11k/spectral.c
+++ b/drivers/net/wireless/ath/ath11k/spectral.c
@@ -141,16 +141,8 @@ static struct dentry *create_buf_file_handler(const char *filename,
 	return buf_file;
 }
 
-static int remove_buf_file_handler(struct dentry *dentry)
-{
-	debugfs_remove(dentry);
-
-	return 0;
-}
-
 static const struct rchan_callbacks rfs_scan_cb = {
 	.create_buf_file = create_buf_file_handler,
-	.remove_buf_file = remove_buf_file_handler,
 };
 
 static struct ath11k_vif *ath11k_spectral_get_vdev(struct ath11k *ar)
diff --git a/drivers/net/wireless/ath/ath9k/common-spectral.c b/drivers/net/wireless/ath/ath9k/common-spectral.c
index 628eeec4b82f..5cd808c2d240 100644
--- a/drivers/net/wireless/ath/ath9k/common-spectral.c
+++ b/drivers/net/wireless/ath/ath9k/common-spectral.c
@@ -1025,16 +1025,8 @@ static struct dentry *create_buf_file_handler(const char *filename,
 	return buf_file;
 }
 
-static int remove_buf_file_handler(struct dentry *dentry)
-{
-	debugfs_remove(dentry);
-
-	return 0;
-}
-
 static const struct rchan_callbacks rfs_spec_scan_cb = {
 	.create_buf_file = create_buf_file_handler,
-	.remove_buf_file = remove_buf_file_handler,
 };
 
 /*********************/
diff --git a/drivers/net/wireless/mediatek/mt76/mt7915/debugfs.c b/drivers/net/wireless/mediatek/mt76/mt7915/debugfs.c
index 578013884e43..5615fd87a2aa 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7915/debugfs.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/debugfs.c
@@ -598,20 +598,11 @@ create_buf_file_cb(const char *filename, struct dentry *parent, umode_t mode,
 	return f;
 }
 
-static int
-remove_buf_file_cb(struct dentry *f)
-{
-	debugfs_remove(f);
-
-	return 0;
-}
-
 static int
 mt7915_fw_debug_bin_set(void *data, u64 val)
 {
 	static struct rchan_callbacks relay_cb = {
 		.create_buf_file = create_buf_file_cb,
-		.remove_buf_file = remove_buf_file_cb,
 	};
 	struct mt7915_dev *dev = data;
 
diff --git a/drivers/net/wireless/mediatek/mt76/mt7996/debugfs.c b/drivers/net/wireless/mediatek/mt76/mt7996/debugfs.c
index 7b2bb72b407d..dff3160ef051 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7996/debugfs.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7996/debugfs.c
@@ -391,20 +391,11 @@ create_buf_file_cb(const char *filename, struct dentry *parent, umode_t mode,
 	return f;
 }
 
-static int
-remove_buf_file_cb(struct dentry *f)
-{
-	debugfs_remove(f);
-
-	return 0;
-}
-
 static int
 mt7996_fw_debug_bin_set(void *data, u64 val)
 {
 	static struct rchan_callbacks relay_cb = {
 		.create_buf_file = create_buf_file_cb,
-		.remove_buf_file = remove_buf_file_cb,
 	};
 	struct mt7996_dev *dev = data;
 
diff --git a/drivers/net/wwan/iosm/iosm_ipc_trace.c b/drivers/net/wwan/iosm/iosm_ipc_trace.c
index eeecfa3d10c5..4fc9ea6520d3 100644
--- a/drivers/net/wwan/iosm/iosm_ipc_trace.c
+++ b/drivers/net/wwan/iosm/iosm_ipc_trace.c
@@ -43,13 +43,6 @@ ipc_trace_create_buf_file_handler(const char *filename,
 				   &relay_file_operations);
 }
 
-/* Removes relay file from debugfs. */
-static int ipc_trace_remove_buf_file_handler(struct dentry *dentry)
-{
-	debugfs_remove(dentry);
-	return 0;
-}
-
 static int ipc_trace_subbuf_start_handler(struct rchan_buf *buf, void *subbuf,
 					  void *prev_subbuf,
 					  size_t prev_padding)
@@ -66,7 +59,6 @@ static int ipc_trace_subbuf_start_handler(struct rchan_buf *buf, void *subbuf,
 static struct rchan_callbacks relay_callbacks = {
 	.subbuf_start = ipc_trace_subbuf_start_handler,
 	.create_buf_file = ipc_trace_create_buf_file_handler,
-	.remove_buf_file = ipc_trace_remove_buf_file_handler,
 };
 
 /* Copy the trace control mode to user buffer */
diff --git a/drivers/net/wwan/t7xx/t7xx_port_trace.c b/drivers/net/wwan/t7xx/t7xx_port_trace.c
index 4ed8b4e29bf1..2a2c71416064 100644
--- a/drivers/net/wwan/t7xx/t7xx_port_trace.c
+++ b/drivers/net/wwan/t7xx/t7xx_port_trace.c
@@ -26,12 +26,6 @@ static struct dentry *t7xx_trace_create_buf_file_handler(const char *filename,
 				   &relay_file_operations);
 }
 
-static int t7xx_trace_remove_buf_file_handler(struct dentry *dentry)
-{
-	debugfs_remove(dentry);
-	return 0;
-}
-
 static int t7xx_trace_subbuf_start_handler(struct rchan_buf *buf, void *subbuf,
 					   void *prev_subbuf, size_t prev_padding)
 {
@@ -46,7 +40,6 @@ static int t7xx_trace_subbuf_start_handler(struct rchan_buf *buf, void *subbuf,
 static struct rchan_callbacks relay_callbacks = {
 	.subbuf_start = t7xx_trace_subbuf_start_handler,
 	.create_buf_file = t7xx_trace_create_buf_file_handler,
-	.remove_buf_file = t7xx_trace_remove_buf_file_handler,
 };
 
 static void t7xx_trace_port_uninit(struct t7xx_port *port)
diff --git a/include/linux/relay.h b/include/linux/relay.h
index 72b876dd5cb8..820f8753eeef 100644
--- a/include/linux/relay.h
+++ b/include/linux/relay.h
@@ -133,20 +133,6 @@ struct rchan_callbacks
 					  umode_t mode,
 					  struct rchan_buf *buf,
 					  int *is_global);
-
-	/*
-	 * remove_buf_file - remove file representing a relay channel buffer
-	 * @dentry: the dentry of the file to remove
-	 *
-	 * Called during relay_close(), once for each per-cpu buffer,
-	 * to allow the client to remove a file used to represent a
-	 * channel buffer.
-	 *
-	 * The callback should return 0 if successful, negative if not.
-	 *
-	 * This callback is mandatory.
-	 */
-	int (*remove_buf_file)(struct dentry *dentry);
 };
 
 /*
diff --git a/kernel/relay.c b/kernel/relay.c
index a8ae436dc77e..300eff05f5ab 100644
--- a/kernel/relay.c
+++ b/kernel/relay.c
@@ -22,6 +22,7 @@
 #include <linux/mm.h>
 #include <linux/cpu.h>
 #include <linux/splice.h>
+#include <linux/debugfs.h>
 
 /* list of open channels, for cpu hotplug */
 static DEFINE_MUTEX(relay_channels_mutex);
@@ -426,7 +427,7 @@ static void relay_close_buf(struct rchan_buf *buf)
 {
 	buf->finalized = 1;
 	irq_work_sync(&buf->wakeup_work);
-	buf->chan->cb->remove_buf_file(buf->dentry);
+	debugfs_remove(buf->dentry);
 	kref_put(&buf->kref, relay_remove_buf);
 }
 
@@ -486,7 +487,7 @@ struct rchan *relay_open(const char *base_filename,
 		return NULL;
 	if (subbuf_size > UINT_MAX / n_subbufs)
 		return NULL;
-	if (!cb || !cb->create_buf_file || !cb->remove_buf_file)
+	if (!cb || !cb->create_buf_file)
 		return NULL;
 
 	chan = kzalloc(sizeof(struct rchan), GFP_KERNEL);
diff --git a/kernel/trace/blktrace.c b/kernel/trace/blktrace.c
index 3679a6d18934..8a383d542d9e 100644
--- a/kernel/trace/blktrace.c
+++ b/kernel/trace/blktrace.c
@@ -473,13 +473,6 @@ static int blk_subbuf_start_callback(struct rchan_buf *buf, void *subbuf,
 	return 0;
 }
 
-static int blk_remove_buf_file_callback(struct dentry *dentry)
-{
-	debugfs_remove(dentry);
-
-	return 0;
-}
-
 static struct dentry *blk_create_buf_file_callback(const char *filename,
 						   struct dentry *parent,
 						   umode_t mode,
@@ -493,7 +486,6 @@ static struct dentry *blk_create_buf_file_callback(const char *filename,
 static const struct rchan_callbacks blk_relay_callbacks = {
 	.subbuf_start		= blk_subbuf_start_callback,
 	.create_buf_file	= blk_create_buf_file_callback,
-	.remove_buf_file	= blk_remove_buf_file_callback,
 };
 
 static void blk_trace_setup_lba(struct blk_trace *bt,
@@ -1902,4 +1894,3 @@ void blk_fill_rwbs(char *rwbs, blk_opf_t opf)
 EXPORT_SYMBOL_GPL(blk_fill_rwbs);
 
 #endif /* CONFIG_EVENT_TRACING */
-

base-commit: a64dcfb451e254085a7daee5fe51bf22959d52d3
